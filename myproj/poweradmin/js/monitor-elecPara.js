function leaveConfirm(){window.onbeforeunload=function(i){var e="编辑可能未保存，真的要离开吗？";return(i||window.event).returnValue=e}}layui.use(["table","layer","laydate"],function(){var i=layui.table,n=layui.laydate,y=layui.layer;function c(i){n.render({elem:i,type:"time",format:"HH:mm:ss",value:new Date,isInitValue:!0,done:function(i){}})}function e(i,e){$(i).change(function(){var i=$(this).val();(i=parseInt(i))&&NaN!==i&&e&&e(i)})}$(".table-separate").on("click",".time-cell",function(){var e=$(this),a=$(this).parents("td"),i=e.text(),l=$(this).parent(".layui-table-cell").outerWidth(),t=$('<input type="text" class="cell-edit cell-time">').width(l).attr("value",i);$(this).parents("td").append(t),n.render({elem:t[0],type:"time",format:"HH:mm:ss",value:new Date,isInitValue:!0,done:function(i){if(""==i)return!1;e.text(i),a.data("content",i),t.hide()}})});var d=[{id:12,nodeId:1001,nodeName:"1#设备",volLimit:68,volLowLimit:0,curLimit:79,curLowLimit:78,powerFactor:0,imbalance:0,lossOfPhase:0,overload:0},{id:13,nodeId:1002,nodeName:"2#设备",volLimit:0,volLowLimit:0,curLimit:0,curLowLimit:0,powerFactor:0,imbalance:0,lossOfPhase:0,overload:0}],m=[],o=i.render({elem:"#compare",cols:[[{field:"id",title:"ID"},{field:"demand",title:"demand"},{field:"nodeId",title:"设备id",minWidth:100,templet:'<div><span class="txel">{{d.nodeId}}</span></div>'},{field:"nodeName",title:"名称",templet:'<div><span class="txel">{{d.nodeName}}</span></div>'},{field:"volLimit",title:"电压上限",minWidth:100,event:"cellClick",edit:"text",templet:'<div><span class="txel">{{d.volLimit}}</span></div>'},{field:"volLowLimit",title:"电压下限",minWidth:100,event:"cellClick",edit:"text",templet:'<div><span class="txel">{{d.volLowLimit}}</span></div>'},{field:"curLimit",title:"电流上限",minWidth:100,event:"cellClick",edit:"text",templet:'<div><span class="txel">{{d.curLimit}}</span></div>'},{field:"curLowLimit",title:"电流下限",minWidth:100,event:"cellClick",edit:"text",templet:'<div><span class="txel">{{d.curLowLimit}}</span></div>'},{field:"powerFactor",title:"功率因数",minWidth:100,event:"cellClick",edit:"text",templet:'<div><span class="txel">{{d.powerFactor}}</span></div>'},{field:"imbalance",title:"不平衡",event:"cellClick",edit:"text",templet:'<div><span class="txel">{{d.imbalance}}</span></div>'},{field:"lossOfPhase",title:"断相",event:"cellClick",edit:"text",templet:'<div><span class="txel">{{d.lossOfPhase}}</span></div>'},{field:"overload",title:"过载",event:"cellClick",edit:"text",templet:'<div><span class="txel">{{d.overload}}</span></div>'},{field:"operate",title:"操作",edit:"text",toolbar:"#toolbar"}]],data:d,done:function(i){$("[data-field='id']").css("display","none"),$("[data-field='demand']").css("display","none"),$("td[data-content]").data("oldval",0)}});$("#menuTree").contextMenu({selector:"a",items:{firstCommand:{name:"设置阈值",icon:"set",className:"contextmenu-set",callback:function(i,e,a){var l,t,n=$(this).text();nodeId=$(this).data("menuid"),l=nodeId,t=n,y.open({type:1,title:"新增阈值",area:"1060px",closeBtn:0,skin:"layer-dialog",content:'<div class="dialog-form-wrap"><form method="post" class="layui-form add-plan"><div class="input-group"><div class="inputs-im"><div class="layui-inline"><label class="layui-form-label">设备id</label><div class="layui-input-inline"><input type="text" name="nodeId" autocomplete="off" readonly class="layui-input" value="'+l+'"></div></div><div class="layui-inline"><label class="layui-form-label">名称</label><div class="layui-input-inline"><input type="text" name="deviceName" autocomplete="off" readonly class="layui-input" value="'+t+'"></div></div><div class="layui-inline"><label class="layui-form-label">电压上限</label><div class="layui-input-inline"><input type="text" name="volLimit" autocomplete="off" class="layui-input" placeholder="请输入数字"></div></div><div class="layui-inline"><label class="layui-form-label">电压下限</label><div class="layui-input-inline"><input type="text" name="volLowLimit" autocomplete="off" class="layui-input" placeholder="请输入数字"></div></div><div class="layui-inline"><label class="layui-form-label">电流上限</label><div class="layui-input-inline"><input type="text" name="curLimit" autocomplete="off" class="layui-input" placeholder="请输入数字"></div></div><div class="layui-inline"><label class="layui-form-label">电流下限</label><div class="layui-input-inline"><input type="text" name="curLowLimit" autocomplete="off" class="layui-input" placeholder="请输入数字"></div></div><div class="layui-inline"><label class="layui-form-label">功率因数</label><div class="layui-input-inline"><input type="text" name="powerFactor" autocomplete="off" class="layui-input" placeholder="请输入数字"></div></div><div class="layui-inline"><label class="layui-form-label">不平衡</label><div class="layui-input-inline"><input type="text" name="imbalance" autocomplete="off" class="layui-input" placeholder="请输入数字"></div></div><div class="layui-inline"><label class="layui-form-label">断相</label><div class="layui-input-inline"><input type="text" name="lossOfPhase" autocomplete="off" class="layui-input" placeholder="请输入数字"></div></div><div class="layui-inline"><label class="layui-form-label">过载</label><div class="layui-input-inline"><input type="text" name="overload" autocomplete="off" class="layui-input" placeholder="请输入数字"></div></div></form><div class="layui-form-item btn-cont"><div class="layui-input-block"><button class="layui-btn layui-btn-radius subBtn" lay-submit lay-filter="formDemo">确认</button><button class="layui-btn layui-btn-radius cancelBtn">取消</button></div></div></div>',success:function(i,a){var l=i.find(".subBtn"),e=i.find(".cancelBtn"),t=i.find("form");t.on("submit",function(i){i.preventDefault()}),e.click(function(){y.close(a)}),l.click(function(){t.serializeArray();var i=[],e={};t.find(".inputs-im").each(function(){$(this).find("*[name]").each(function(){var i=$(this);if(e[i.attr("name")]=i.val(),"deviceName"==i.attr("name"))e.nodeName=i.val(),delete e.deviceName;else if(!/^([0-9]\d*\.\d*|[0-9]\d*)$/.test(i.val()))return y.msg("格式不正确或者为空，请输入数字",{icon:5}),!1}),i.push(e)}),l.attr("disabled","true"),getData({request:"POST",url:apiRoot+"/api/web/electroparam/addthreshold",token:TOKEN,contentType:"application/json;charset=UTF-8",data:JSON.stringify(e)},function(i){console.log(i),201===i.code?(y.msg("添加成功",{icon:1}),d.push(e),o.reload({data:d}),y.close(a)):y.msg("添加失败，请重试",{icon:5})})})}})}},secondCommand:{name:"选择",icon:"select",className:"contextmenu-select",callback:function(i,e,a){$(".on").removeClass("on"),$(this).addClass("on"),nodeId=$(this).data("menuid"),"undefined"!=typeof nodeId&&nodeId}}}}),i.on("edit(compTable)",function(i){i.value,i.data,i.field}),i.on("tool(compTable)",function(i){var e=i.data,a=i.event,l=i.tr,t=$(l).data("index"),n=$(l).find(".btn-contain");function d(){n.children(".ed-de").removeClass("tchide"),n.children(".ens-can").addClass("tchide")}if("cellClick"===a){n.children(".ed-de").addClass("tchide"),n.children(".ens-can").removeClass("tchide");var o=m[t];for(var s in o){(u=$(l).find("td[data-field="+s+"]")).data("oldval",o[s])}}else if("del"===a)y.confirm("真的删除行么",{skin:"layer-dialog"},function(i){y.close(i);e.id});else if("ensure"===a){var c=/^([0-9]\d*\.\d*|[0-9]\d*)$/;for(prop in e)if("nodeName"!=prop){if(!c.test(e[prop]))return y.msg("格式不正确，请输入数字",{icon:5}),!1;e[prop]=Number(e[prop])}d()}else if("cancel"===a){d();var r=m[t];for(var s in r){var u,p=(u=$(l).find("td[data-field="+s+"]")).find(".txel");u.data("content",r[s]),p.text(r[s])}}});var r=[{id:1,id:1,startTime:"2018-7-30 12:00:00",endTime:"2018-7-30 20:00:00",etype:["尖","峰","平","谷"],price:"78"},{id:2,id:2,startTime:"2018-7-30 12:00:00",endTime:"2018-7-30 20:00:00",etype:["尖","峰","平","谷"],price:"86"}],f=[],u=i.render({elem:"#table1",unresize:!0,cols:[[{field:"pricePlanId",title:"方案id"},{field:"id",title:"ID",width:"10%"},{field:"startTime",width:"15%",title:"开始时间",event:"cellClick",templet:'<div><span class="txel time-cell">{{d.startTime}}</span></div>'},{field:"endTime",width:"15%",title:"结束时间",event:"cellClick",templet:'<div><span class="txel time-cell">{{d.endTime}}</span></div>'},{field:"rateName",width:"15%",event:"cellClick",title:"费率",templet:"#selectTpl"},{field:"price",width:"15%",event:"cellClick",edit:"text",title:"费率价格",templet:'<div><span class="txel">{{d.price}}</span></div>'},{field:"operate",width:"15%",title:"操作",toolbar:"#toolbar"}]],data:r,done:function(){$("[data-field='pricePlanId']").css("display","none"),$("[data-field='id']").css("display","none"),$("#table1").next().find('[data-field="startTime"]').css("border-left-width","1px")}});function p(i,a){var l=[],t={};return i.forEach(function(i,e){t[i.name]=i.value,(e+1)%a==0&&(l.push(t),t={})}),l}function a(){var i=$("#pricePlanSel").html();y.open({type:1,title:"新增费率",area:"1150px",closeBtn:0,skin:"layer-dialog",content:'<div class="dialog-form-wrap"><form method="post" class="layui-form add-plan"><div class="layui-form-item"><label class="layui-form-label">方案名称</label><div class="layui-input-inline"><select name="pricePlanId" class="tc-select" lay-ignore>'+i+'</select></div></div><div class="input-group"><div class="inputs-im"><div class="layui-inline"><label class="layui-form-label">开始时间</label><div class="layui-input-inline"><input type="text" name="startTime" autocomplete="off" class="layui-input add-time"></div></div><div class="layui-inline"><label class="layui-form-label">结束时间</label><div class="layui-input-inline"><input type="text" name="endTime" autocomplete="off" class="layui-input add-time"></div></div><div class="layui-inline"><label class="layui-form-label">费率</label><div class="layui-input-inline"><select name="rateName" class="tc-select" lay-ignore><option value="尖">尖</option><option value="峰">峰</option><option value="平">平</option><option value="谷">谷</option></select></div></div><div class="layui-inline"><label class="layui-form-label">费率价格</label><div class="layui-input-inline"><input type="text" name="price" autocomplete="off" class="layui-input" placeholder="请输入数字，保留2位小数"></div></div><div class="layui-inline"><span class="btn-ipt-add btn-priceipt-add"><i class="iconfont icon-add"></i></span><span class="btn-ipt-cut tchide"><i class="iconfont icon-cut"></i></span></div></div></div></form><div class="layui-form-item btn-cont"><div class="layui-input-block"><button class="layui-btn layui-btn-radius subBtn">确认</button><button class="layui-btn layui-btn-radius cancelBtn">取消</button></div></div></div>',success:function(i,a){var e=i.find(".subBtn"),l=i.find(".cancelBtn"),t=i.find("form"),n=i.find(".add-time"),d=i.find('input[name="price"]'),o=i.find('[name="pricePlanId"]');n.each(function(){c(this)}),l.click(function(){y.close(a)}),e.on("click",function(){var i=t.serializeArray();if(!/^[0-9](\.\d{1,4})?$/.test(d.val()))return y.msg("费率价格格式不正确",{icon:5}),!1;var e=p(i.slice(1),4).map(function(i){return i.pricePlanId=o.val(),i});console.log(e),getData({request:"POST",url:apiRoot+"/api/web/electroparam/addrate",token:TOKEN,contentType:"application/json;charset=UTF-8",data:JSON.stringify(e)},function(i){var d;console.log(i),201===i.code?(y.msg("添加成功",{icon:1}),d=nodeId,getData({request:"POST",url:apiRoot+"/api/web/electroparam/priceplan",data:"&nodeId="+d,token:TOKEN},function(i){var e=i.data;if(e){$("#pricePlanSel").data("nodeid",d),$("#pricePlanSel").data("nodeName",d);for(var a=e[0].id,l="",t=0,n=e.length;t<n;t++)l+='<option value="'+e[t].id+'">'+e[t].name+"</option>";$("#pricePlanSel").html(l),s(a)}else y.msg("没有费率方案数据"),$("#pricePlanSel").html("<option>无数据</option>")}),y.close(a)):y.msg("添加失败，请重试",{icon:5})})})}})}function s(i){getData({request:"POST",url:apiRoot+"/api/web/electroparam/rate",data:"&id="+i,token:TOKEN},function(i){var e=i.data;0===e.length&&y.msg("没有费率列表数据");for(var a=[],l=0,t=e.length;l<t;l++){var n=e[l];a.push({pricePlanId:n.pricePlanId,id:n.id,startTime:n.startTime,endTime:n.endTime,rateName:n.rateName,price:n.price})}r=a,f=JSON.parse(JSON.stringify(a)),u.reload({data:a})})}function l(i,e){$("body").on("click",i,function(){var i='<div class="inputs-im">'+e+'<span class="btn-ipt-cut"><i class="iconfont icon-cut"></i></span></div>';$(this).parents(".input-group").append(i),lay(".add-time").each(function(){c(this)})})}i.on("tool(table1)",function(a){var i=a.data,e=a.event,l=a.tr,t=$(l).data("index"),n=$(l).find(".btn-contain"),d=$(l).find(".cell-edit");function o(){n.children(".ed-de").removeClass("tchide"),n.children(".ens-can").addClass("tchide"),d.remove()}if("cellClick"===e){n.children(".ed-de").addClass("tchide"),n.children(".ens-can").removeClass("tchide");var s=f[t];for(var c in s){(u=$(l).find("td[data-field="+c+"]")).data("oldval",s[c])}}else if("del"===e)y.confirm("真的删除行么",{skin:"layer-dialog"},function(i){a.del()});else if("ensure"===e)o(),$(l).find("td[data-content]").each(function(){var i=$(this).data("field"),e=$(this).data("content");"rateName"==i&&(e=$(this).find("input.layui-unselect").val()),a.data[i]=e}),a.update(),console.log(i,nodeId);else if("cancel"===e){o();var r=f[t];for(var c in r){var u,p=(u=$(l).find("td[data-field="+c+"]")).find(".txel");u.data("content",r[c]),"rateName"==c?(u.find(".layui-unselect").val(r[c]),u.find(".layui-anim-upbit").children("dd[lay-value="+r[c]+"]").addClass("layui-this").siblings().removeClass("layui-this")):p.text(r[c])}}}),e("#pricePlanSel",function(i){s(i)}),$(".add-table").click(function(){y.open({type:1,title:"新增方案",area:"1150px",closeBtn:0,skin:"layer-dialog",content:'<div class="dialog-form-wrap"><form method="post" class="layui-form add-plan"><div class="layui-form-item"><label class="layui-form-label">方案名称</label><div class="layui-input-block"><input type="text" name="title" required  lay-verify="required" placeholder="请输入方案名称" autocomplete="off" class="layui-input tit planName"></div></div><div class="input-group"><div class="inputs-im"><div class="layui-inline"><label class="layui-form-label">开始时间</label><div class="layui-input-inline"><input type="text" name="startTime" autocomplete="off" class="layui-input add-time"></div></div><div class="layui-inline"><label class="layui-form-label">结束时间</label><div class="layui-input-inline"><input type="text" name="endTime" autocomplete="off" class="layui-input add-time"></div></div><div class="layui-inline"><label class="layui-form-label">费率</label><div class="layui-input-inline"><select name="rateName" class="tc-select" lay-ignore><option value="尖">尖</option><option value="峰">峰</option><option value="平">平</option><option value="谷">谷</option></select></div></div><div class="layui-inline"><label class="layui-form-label">费率价格</label><div class="layui-input-inline"><input type="text" name="price" autocomplete="off" class="layui-input" placeholder="请输入数字，保留2位小数"></div></div><div class="layui-inline"><span class="btn-ipt-add btn-priceipt-add"><i class="iconfont icon-add"></i></span><span class="btn-ipt-cut tchide"><i class="iconfont icon-cut"></i></span></div></div></div></form><div class="layui-form-item btn-cont"><div class="layui-input-block"><button class="layui-btn layui-btn-radius subBtn" lay-submit lay-filter="formDemo">确认</button><button class="layui-btn layui-btn-radius cancelBtn">取消</button></div></div></div>',success:function(i,t){var e=i.find(".subBtn"),a=i.find(".cancelBtn"),n=i.find("form"),l=i.find(".add-time"),d=i.find(".planName"),o=i.find('input[name="price"]');l.each(function(){c(this)}),a.click(function(){y.close(t)}),e.click(function(){var i=n.serializeArray();if(""==$.trim(d.val()))return y.msg("方案名称不能为空",{icon:5}),!1;if(!/^[0-9](\.\d{1,4})?$/.test(o.val()))return y.msg("费率价格格式不正确",{icon:5}),!1;var e=i.slice(1);[].push(i.slice(0,1));var a=p(e,4);console.log(a);var l={pricePlan:{nodeId:$("#pricePlanSel").data("nodeid"),name:d.val()},rateList:a};getData({request:"POST",url:apiRoot+"/api/web/electroparam/addpriceplanandrate",token:TOKEN,data:"json="+JSON.stringify(l)},function(i){console.log(i),200===i.code?(y.msg("添加成功",{icon:1}),r=r.concat(a),u.reload({data:r}),y.close(t)):y.msg("添加失败，请重试",{icon:5})})})}})}),$(".add-price").click(function(){a()}),$(".del-price").click(function(){var n,i;n="/api/web/electroparam/delpriceplan",i=$("#pricePlanSel").html(),y.open({type:1,title:"删除方案",closeBtn:0,skin:"layer-dialog",content:'<div class="dialog-form-wrap"><form class="layui-form add-plan"><div class="layui-form-item"><label class="layui-form-label">方案名称</label><div class="layui-input-block"><select name="planId" class="tc-select" lay-ignore>'+i+'</select></div></div></form><div class="layui-form-item btn-cont"><div class="layui-input-block"><button class="layui-btn layui-btn-radius subBtn">确认</button><button class="layui-btn layui-btn-radius cancelBtn">取消</button></div></div></div>',success:function(i,e){var a=i.find(".subBtn"),l=i.find(".cancelBtn"),t=(i.find("form"),i.find('[name="planId"]'));l.click(function(){y.close(e)}),a.click(function(){getData({request:"POST",url:apiRoot+n,token:TOKEN,data:"id="+t.val()},function(i){console.log(i),200===i.code?y.msg("删除成功",{icon:1}):y.msg("删除失败，请重试",{icon:5}),y.close(e)})})}})});l(".btn-priceipt-add",'<div class="layui-inline"><label class="layui-form-label">开始时间</label><div class="layui-input-inline"><input type="text" name="starTime" autocomplete="off" class="layui-input add-time"></div></div><div class="layui-inline"><label class="layui-form-label">结束时间</label><div class="layui-input-inline"><input type="text" name="endTime" autocomplete="off" class="layui-input add-time"></div></div><div class="layui-inline"><label class="layui-form-label">费率</label><div class="layui-input-inline"><select name="rateName" class="tc-select" lay-ignore><option value="尖">尖</option><option value="峰">峰</option><option value="平">平</option><option value="谷">谷</option></select></div></div><div class="layui-inline"><label class="layui-form-label">费率价格</label><div class="layui-input-inline"><input type="text" name="price" autocomplete="off" class="layui-input" placeholder="请输入数字，保留2位小数"></div></div>');var t='<div class="layui-inline"><label class="layui-form-label">班次名称</label><div class="layui-input-inline"><input type="text" name="name" autocomplete="off" class="layui-input" placeholder="班次名称"></div></div><div class="layui-inline"><label class="layui-form-label">开始时间</label><div class="layui-input-inline"><input type="text" name="startTime" autocomplete="off" class="layui-input add-time"></div></div><div class="layui-inline"><label class="layui-form-label">结束时间</label><div class="layui-input-inline"><input type="text" name="endTime" autocomplete="off" class="layui-input add-time"></div></div>';l(".btn-workIpt-add",t),$("body").on("click",".btn-ipt-cut",function(){$(this).parents(".inputs-im").remove()}),$("body").on("click","layui-input.add-time",function(){c(this)});var v=[{flightPlanId:23,id:1,name:"班次1",startTime:"2018-7-30 12:00",endTime:"2018-7-30 20:00"},{flightPlanId:24,id:2,name:"班次2",startTime:"2018-7-30 12:00",endTime:"2018-7-30 20:00"}],b=[],h=i.render({elem:"#table2",unresize:!0,cols:[[{field:"flightPlanId",title:"费率方案id"},{field:"id",title:"ID"},{field:"name",title:"班次",width:"20%",templet:'<div><span class="txel">{{d.name}}</span></div>'},{field:"startTime",title:"上班时间",width:"25%",event:"cellClick",templet:'<div><span class="txel time-cell">{{d.startTime}}</span><i class="iconfont icon-edit editTime"></i></div>'},{field:"endTime",title:"下班时间",width:"25%",event:"cellClick",templet:'<div><span class="txel time-cell">{{d.endTime}}</span><i class="iconfont icon-edit editTime"></i></div>'},{field:"operate",title:"操作",width:"20%",toolbar:"#toolbar"}]],data:v,done:function(i){$("[data-field='flightPlanId']").css("display","none"),$("[data-field='id']").css("display","none"),$("#table2").next().find('[data-field="name"]').css("border-left-width","1px")}});function g(i){getData({request:"POST",url:apiRoot+"/api/web/electroparam/fligh",data:"&id="+i,token:TOKEN},function(i){var e=i.data;0===e.length&&y.msg("没有班次列表数据");for(var a=[],l=0,t=e.length;l<t;l++){var n=e[l];a.push({flightPlanId:n.flightPlanId,id:n.id,name:n.name,startTime:n.startTime,endTime:n.endTime})}v=a,b=JSON.parse(JSON.stringify(a)),h.reload({data:a})})}i.on("tool(table2)",function(a){a.data;var i=a.event,e=a.tr,l=$(e).data("index"),t=$(e).find(".btn-contain"),n=$(e).find(".cell-edit");function d(){t.children(".ed-de").removeClass("tchide"),t.children(".ens-can").addClass("tchide"),n.remove()}if("cellClick"===i){t.children(".ed-de").addClass("tchide"),t.children(".ens-can").removeClass("tchide");var o=b[l];for(var s in o){(r=$(e).find("td[data-field="+s+"]")).data("oldval",o[s])}}else if("del"===i)y.confirm("真的删除行么",{skin:"layer-dialog"},function(i){});else if("ensure"===i)d(),$(e).find("td[data-content]").each(function(){var i=$(this).data("field"),e=$(this).data("content");a.data[i]=e}),a.update();else if("cancel"===i){d();var c=b[l];for(var s in c){var r,u=(r=$(e).find("td[data-field="+s+"]")).find(".txel");r.data("content",c[s]),u.text(c[s])}}}),e("#workSel",function(i){g(i)}),$(".add-work-plan").click(function(){y.open({type:1,title:"新增班次方案",area:"1060px",closeBtn:0,skin:"layer-dialog",content:'<div class="dialog-form-wrap"><form method="post" class="layui-form add-plan"><div class="layui-form-item"><label class="layui-form-label">方案名称</label><div class="layui-input-block"><input type="text" name="title" required  lay-verify="required" placeholder="请输入方案名称" autocomplete="off" class="layui-input tit planName"></div></div><div class="input-group"><div class="inputs-im"><div class="layui-inline"><label class="layui-form-label">班次名称</label><div class="layui-input-inline"><input type="text" name="name" autocomplete="off" class="layui-input workshift-name" placeholder="请输入班次名称"></div></div><div class="layui-inline"><label class="layui-form-label">开始时间</label><div class="layui-input-inline"><input type="text" name="startTime" autocomplete="off" class="layui-input add-time"></div></div><div class="layui-inline"><label class="layui-form-label">结束时间</label><div class="layui-input-inline"><input type="text" name="endTime" autocomplete="off" class="layui-input add-time"></div></div><div class="layui-inline"><span class="btn-ipt-add btn-workIpt-add"><i class="iconfont icon-add"></i></span><span class="btn-ipt-cut tchide"><i class="iconfont icon-cut"></i></span></div></div></div></form><div class="layui-form-item btn-cont"><div class="layui-input-block"><button class="layui-btn layui-btn-radius subBtn" lay-submit lay-filter="formDemo">确认</button><button class="layui-btn layui-btn-radius cancelBtn">取消</button></div></div></div>',success:function(i,t){var e=i.find(".subBtn"),a=i.find(".cancelBtn"),n=i.find("form"),l=i.find(".add-time"),d=i.find(".planName"),o=i.find(".workshift-name");l.each(function(){c(this)}),a.click(function(){y.close(t)}),e.click(function(){var i=n.serializeArray();if(""==$.trim(d.val()))return y.msg("方案名称不能为空",{icon:5}),!1;if(""==$.trim(o.val()))return y.msg("班次名称不能为空",{icon:5}),!1;var e=i.slice(1),a=p(e,3);console.log(a);var l={flightPlan:{nodeId:$("#workSel").data("nodeid"),name:d.val()},flightList:a};getData({request:"POST",url:apiRoot+"/api/web/electroparam/addflightplanandflight",token:TOKEN,data:"json="+JSON.stringify(l)},function(i){var d;console.log(i),200===i.code?(y.msg("添加成功",{icon:1}),d=nodeId,getData({request:"POST",url:apiRoot+"/api/web/electroparam/flightplan",data:"&nodeId="+d,token:TOKEN},function(i){var e=i.data;if(e){$("#workSel").data("nodeid",d),e[0].nodeName&&$("#workSel").data("nodeName",e[0].nodeName);for(var a=e[0].id,l="",t=0,n=e.length;t<n;t++)l+='<option value="'+e[t].id+'">'+e[t].name+"</option>";$("#workSel").html(l),g(a)}else y.msg("没有班次方案数据"),$("#workSel").html("<option>无数据</option>")}),y.close(t)):y.msg("添加失败，请重试",{icon:5})})})}})}),$(".add-work-price").click(function(){var i;i=$("#workSel").html(),y.open({type:1,title:"新增班次",area:"1060px",closeBtn:0,skin:"layer-dialog",content:'<div class="dialog-form-wrap"><form method="post" class="layui-form add-plan"><div class="layui-form-item"><label class="layui-form-label">方案名称</label><div class="layui-input-inline"><select name="flightPlanId" class="tc-select" lay-ignore>'+i+'</select></div></div><div class="input-group"><div class="inputs-im">'+t+'<div class="layui-inline"><span class="btn-ipt-add btn-workIpt-add"><i class="iconfont icon-add"></i></span><span class="btn-ipt-cut tchide"><i class="iconfont icon-cut"></i></span></div></div></div></form><div class="layui-form-item btn-cont"><div class="layui-input-block"><button class="layui-btn layui-btn-radius subBtn">确认</button><button class="layui-btn layui-btn-radius cancelBtn">取消</button></div></div></div>',success:function(i,n){var e=i.find(".subBtn"),a=i.find(".cancelBtn"),d=i.find("form"),l=i.find(".add-time"),o=i.find('input[name="name"]'),s=i.find('[name="flightPlanId"]');l.each(function(){c(this)}),a.click(function(){y.close(n)}),e.on("click",function(){var i=d.serializeArray();if(""==$.trim(o.val()))return y.msg("班次名称不能为空",{icon:5}),!1;var e=i.slice(1),a=p(e,3),l=a.map(function(i){return i.flightPlanId=s.val(),i});console.log(l);var t=y.load();getData({request:"POST",url:apiRoot+"/api/web/electroparam/addflight",token:TOKEN,contentType:"application/json;charset=UTF-8",data:JSON.stringify(l)},function(i){console.log(i),201===i.code?(y.msg("添加成功",{icon:1}),r=r.concat(l),u.reload({data:r}),y.close(t),y.close(n)):y.msg("添加失败，请重试",{icon:5})})})}})}),$(".del-work-plan").click(function(){});var w=$("#powerGroupLoading");function x(i){getData({request:"POST",url:apiRoot+"/api/web/electroparam/energygroupdetails",data:"&id="+i,token:TOKEN},function(i){if(i&&i.data&&200===i.code){var e=i.data;0===e.length&&(y.msg("没有能耗组详情数据"),$("#powerGroupbox > ul").html('<p style="text-align: center">无数据</p>'));for(var a=[],l=0,t=e.length;l<t;l++){var n=e[l];a.push({energyGroupId:n.energyGroupId,powerGridId:n.powerGridId,powerGridName:n.powerGridName})}for(var d="",o=0;o<a.length;o++){var s='<div class="device-im" data-menuId="'+a[o].powerGridId+'">'+a[o].powerGridName+"</div>";d+=o%8==0?"<li>"+s:s}a.length%8==1&&(d+="</li>"),$("#powerGroupbox > ul").html(d),tableLoadingHide(w)}})}function k(p){var i="操作",e="",m="添加成功",f="添加失败，请重试";if("add"==p)i="新增能耗组",m="添加成功",f="添加失败，请重试";else if("edit"==p){i="编辑能耗组",m="修改成功",f="修改失败，请重试",e=$("#powerGroupSel").find("option:selected").text();var v=$("#powerGroupSel").val()}y.open({type:1,title:i,area:"1060px",skin:"layer-dialog",content:'<div class="dialog-power-group clearfix"><div class="power-group-left fl"><div class="menu-tree-box"><div id="power-group-tree" class="tree-menu-wrap"><ul></ul></div></div></div><div class="dialog-form-wrap power-group-right fl"><form method="post" class="layui-form add-plan"><div class="layui-form-item"><label class="layui-form-label">能耗组名称*</label><div class="layui-input-block"><input type="text" name="title" required  lay-verify="required" placeholder="请输入能耗组名称" autocomplete="off" class="layui-input tit planName" value="'+e+'"></div></div><div class="device-group"><div class="chosetip">选择对象<span>（鼠标右键单击选择左侧树中的设备，不低于2个对象）<span></div><div id="device-box" class="device-box"></div></div></form><div class="layui-form-item btn-cont"><div class="layui-input-block"><button class="layui-btn layui-btn-radius subBtn" lay-submit lay-filter="powerGroup">确认</button><button class="layui-btn layui-btn-radius cancelBtn">取消</button></div></div></div></div>',success:function(i,a){var e=i.find(".subBtn"),l=i.find(".cancelBtn"),t=(i.find("form"),i.find(".planName")),n=i.find("#power-group-tree"),d=i.find("#device-box");l.click(function(){y.close(a)});var o=$("#tree-menu-wrap").html();n.html(o),$("#power-group-tree").on("click","ul>li a",function(){$(this).children(".icon-arr-menu").toggleClass("exspand"),$(this).next().toggle()}),$("#device-box").on("click",".closeIcon",function(){$(this).parent(".device-tag").remove()}),$("#power-group-tree").contextMenu({selector:"a",items:{firstCommand:{name:"添加",icon:"add",className:"contextmenu-add",callback:function(i,e,a){var l=$(this).text(),t=$(this).data("menuid"),n='<span class="device-tag" data-menuid="'+t+'">'+l+'<i class="closeIcon"></i></span>';$("#device-box").append(n)}}}});var s=$("#powerGroupbox").find(".device-im");if("edit"==p&&0<s.length){var c="";s.each(function(){var i=$(this).text(),e=$(this).data("menuid");c+='<span class="device-tag" data-menuid="'+e+'">'+i+'<i class="closeIcon"></i></span>'}),d.html(c)}var r=[],u=[];e.click(function(){if(""==$.trim(t.val()))return y.msg("名称不能为空",{icon:5}),!1;var l;if(d.children(".device-tag").each(function(){var i=$(this).data("menuid"),e=$(this).text();u.push({powerGridId:i,powerGridName:e})}),l={},(u=u.filter(function(i,e,a){return!l.hasOwnProperty(typeof i+JSON.stringify(i))&&(l[typeof i+JSON.stringify(i)]=!0)})).length<2)return y.msg("必须选择2个以上对象且不重复",{icon:5}),!1;r={energyGroup:{name:t.val()},energyPowerGrid:u},"edit"==p&&(r={energyGroup:{id:v},energyPowerGrid:u});var e=y.load();getData({request:"POST",url:apiRoot+"/api/web/electroparam/energygroupAdd",token:TOKEN,data:"json="+JSON.stringify(r)},function(i){console.log(i),201===i.code?(y.msg(m,{icon:1}),y.close(e),y.close(a),getData({request:"POST",url:apiRoot+"/api/web/electroparam/energygroup",token:TOKEN},function(i){if(200===i.code){var e=i.data;if(null==e||0===e.length)y.msg("没有能耗组数据"),$("#powerGroupSel").html(""),$("#powerGroupbox").html('<p style="text-align: center;color: #999;">无数据</p>');else{for(var a=e[0].id,l="",t=0,n=e.length;t<n;t++)l+='<option value="'+e[t].id+'">'+e[t].name+"</option>";$("#powerGroupSel").html(l),x(a)}}})):(y.msg(f,{icon:5}),y.close(e))})})}})}e("#powerGroupSel",function(i){tableLoadingShow(w),x(i)}),$(".add-power-group").on("click",function(){k("add")}),$(".edit-power-group").on("click",function(){k("edit")}),$(".del-power-group").on("click",function(){})});