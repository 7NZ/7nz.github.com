$(function(){var y,A=0,T=null,L="",w="",C="day",k=2,O=0,E=1,N=[],D=0,q=0;layui.use(["table","layer","laydate","laypage"],function(){var e=layui.table,a=layui.laydate,l=layui.layer,n=layui.laypage;lay(".time-range").each(function(){a.render({elem:this,type:"datetime",format:"yyyy-MM-dd HH:mm",isInitValue:!0,range:!0,done:function(e){var a=e.split(" - ");L=a[0],w=a[1]}})});var t={colors:{chartBg:"transparent",axisLineC:"#ebeef0",xAxisLabelC:"#99a8bf",yAxisLabelC:"#4a4b56",legendC:"#333",legendC2:"#646487"}},i=($("#chart_a").outerWidth(),{radius:document.documentElement.clientWidth<=1400?"48%":"54%"}),r=echarts.init(document.getElementById("chart_a")),s=[1e3,2e3,1400,1200,1800,1500,1700,1300,1350,1400,1460,1520,1480,1394,1458,1568,1520,1620,1494],o=s.map(function(e){return e*Math.ceil(1.2*Math.random())}),d=s.map(function(e){return e*Math.ceil(1.5*Math.random())}),c={backgroundColor:t.colors.chartBg,color:["#8757f8","#0099ff","#ffb300","#f87761","#5dc99a","#ffe535"],toolbox:{feature:{saveAsImage:{}}},dataZoom:[{type:"slider",start:0,end:10},{type:"inside",start:0,end:10}],grid:{left:"1%",right:"35%",bottom:"12%",containLabel:!0},tooltip:[{trigger:"axis",padding:0,formatter:function(e){for(var a='<div class="chartTooltip bg-global wid-limit"><div class="trang"></div>',t=0;t<e.length;t++)a+='<span class="item">'+e[t].seriesName+"："+e[t].value+"</span>";return a+="</div>"}}],legend:{itemWidth:10,itemHeight:10,textStyle:{color:t.colors.legendC},data:["电压","电流","功率因素","负荷","温度","三相不平衡"]},xAxis:{axisLabel:{color:t.colors.xAxisLabelC},axisLine:{lineStyle:{color:t.colors.axisLineC}},data:["10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00"]},yAxis:{name:"数量",nameTextStyle:{color:t.colors.legendC},axisLine:{show:!1,lineStyle:{color:t.colors.axisLineC}},axisLabel:{color:t.colors.yAxisLabelC},splitLine:{show:!0,lineStyle:{color:t.colors.axisLineC}}},series:[{name:"电压",type:"bar",stack:"总量",color:["#8757f8"],data:s},{name:"电流",type:"bar",stack:"总量",color:["#0099ff"],data:o},{name:"功率因素",type:"bar",stack:"总量",color:["#ffb300"],data:o},{name:"负荷",type:"bar",stack:"总量",color:["#f87761"],data:d},{name:"温度",type:"bar",stack:"总量",color:["#5dc99a"],data:s},{name:"三相不平衡",type:"bar",stack:"总量",color:["#ffe535"],data:s},{type:"pie",radius:i.radius,center:["86%","50%"],roseType:"radius",avoidLabelOverlap:!0,tooltip:{padding:5,trigger:"item",formatter:"{b}<br/>{c} ({d}%)"},label:{normal:{show:!0,position:"outside",fontSize:12,color:t.colors.labelC},emphasis:{show:!0,position:"center",extraCssText:"box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);"}},labelLine:{normal:{show:!0,length:10,length2:15}},data:[{value:0,name:"电压"},{value:0,name:"电流"},{value:0,name:"功率因素"},{value:0,name:"负荷"},{value:0,name:"温度"},{value:0,name:"三相不平衡"}]}]};function p(){var e,a;r.showLoading(),e=T,a=apiRoot+"/api/web/Alarm/alarm/"+C+(e?"/"+e:""),getData({request:"GET",url:a,token:TOKEN,contentType:"application/json;charset=UTF-8"},function(e){if(e&&200===e.code&&e.data&&e.data.alarmNum){var a=e.data.alarmNum;if(0===a.length)$("#chart_a").append('<div class="chart-nodata"><div class="table-box"><div class="table-cell"><p class="chart-tip">暂无数据</p></div></div></div>'),r.hideLoading();else{var t=a,i=x(t);N=i,c.xAxis.data=i.timeArr,c.series[0].data=i.seriesArr.voltage,c.series[1].data=i.seriesArr.currents,c.series[2].data=i.seriesArr.pf,c.series[3].data=i.seriesArr.load,c.series[4].data=i.seriesArr.temperature,c.series[5].data=i.seriesArr.unbalance,h(i,0),r.setOption(c),r.hideLoading()}}})}function m(){var e,a;r.showLoading(),e=T,a=apiRoot+"/api/web/Alarm/alarm/custom"+(e?"/"+e:"")+"/"+L+"/"+w,getData({request:"GET",url:a,token:TOKEN,contentType:"application/json;charset=UTF-8"},function(e){if(e&&200===e.code&&e.data&&e.data.alarmNum){var a=e.data.alarmNum;if(0===a.length)$("#chart_a").append('<div class="chart-nodata"><div class="table-box"><div class="table-cell"><p class="chart-tip">暂无数据</p></div></div></div>'),r.hideLoading();else{var t=x(a);N=t,c.xAxis.data=t.timeArr,c.series[0].data=t.seriesArr.voltage,c.series[1].data=t.seriesArr.currents,c.series[2].data=t.seriesArr.pf,c.series[3].data=t.seriesArr.load,c.series[4].data=t.seriesArr.temperature,c.series[5].data=t.seriesArr.unbalance,h(t,0),r.setOption(c),r.hideLoading()}}})}function u(){var s,e,a,t=$("#tableLoading");tableLoadingShow(t),s=t,e=T,a=apiRoot+"/api/web/Alarm/alarm/table/"+C+(e?"/"+e:"")+"/"+E+"/"+20+"/"+k,getData({request:"GET",url:a,token:TOKEN,contentType:"application/json;charset=UTF-8"},function(e){if(e&&200===e.code&&e.data&&e.data.alarmTable){var a=e.data.alarmTable,t=e.data.alarmTableNum,i=e.data.nowpage,r=e.data.page_size;b.reload({limit:r,data:a}),n.render({elem:"warnTablePage",count:t,curr:i,limit:r,theme:"#07c3a9",jump:function(e,a){E=e.curr,r=e.limit,a||u()}}),tableLoadingHide(s)}})}function v(){var s,e,a,t=$("#tableLoading");tableLoadingShow(t),s=t,e=T,a=apiRoot+"/api/web/Alarm/alarm/table/custom"+(e?"/"+e:"")+"/"+L+"/"+w+"/"+E+"/"+20+"/"+k,getData({request:"GET",url:a,token:TOKEN,contentType:"application/json;charset=UTF-8"},function(e){if(e&&200===e.code&&e.data&&e.data.alarmTable){var a=e.data.alarmTable,t=e.data.alarmTableNum,i=e.data.nowpage,r=e.data.page_size;b.reload({limit:r,data:a}),n.render({elem:"warnTablePage",count:t,curr:i,limit:r,theme:"#07c3a9",jump:function(e,a){E=e.curr,r=e.limit,a||u()}}),tableLoadingHide(s)}})}function f(){r.resize()}r.setOption(c),r.on("click",function(e){"bar"===e.seriesType&&(h(N,e.dataIndex),r.setOption(c))}),r.on("datazoom",function(e){"datazoom"===e.type&&void 0!==e.start&&void 0!==e.end&&(D=e.start.toFixed(2),q=e.end.toFixed(2),c.dataZoom[0].start=D,c.dataZoom[0].end=q,c.dataZoom[1].start=D,c.dataZoom[1].end=q)}),$('input[name="datetype"]').on("change",function(){var e=$("input[name='datetype']:checked").val();switch(C=e,k=2,E=1,$(".chart-nodata").remove(),c.dataZoom[0].start=0,c.dataZoom[0].end=10,c.dataZoom[1].start=0,c.dataZoom[1].end=10,e){case"day":$(".select-date").addClass("tchide"),A=0;break;case"month":$(".select-date").addClass("tchide"),A=1;break;case"year":$(".select-date").addClass("tchide"),A=2;break;case"custom":$(".select-date").removeClass("tchide"),$(".time-range").val(""),w=L="",A=3}}),window.addEventListener("resize",function(){f()}),$("#listenInput").on("blur change",function(){setTimeout(function(){f()},300)});var b=e.render({elem:"#warnTABLE",cols:[[{field:"id",title:"ID",minWidth:150,templet:'<div><span class="txel">{{d.id}}</span></div>'},{field:"POC_ID",title:"报警点编号",templet:'<div><span class="txel">{{d.POC_ID}}</span></div>'},{field:"name",title:"名称",templet:'<div><span class="txel">{{d.name}}</span></div>'},{field:"type",title:"报警类型",templet:'<div><span class="txel">{{d.type}}</span></div>'},{field:"reasons",title:"报警因素",templet:'<div><span class="txel">{{d.reasons}}</span></div>'},{field:"time",title:"报警时间",templet:'<div><span class="txel">{{d.time}}</span></div>'},{field:"lev",title:"报警级别",templet:'<div><span class="txel">{{d.lev}}</span></div>'},{field:"current",title:"当前值",templet:'<div><span class="txel">{{d.current}}</span></div>'},{field:"exceed",title:"越限制",templet:'<div><span class="txel">{{d.exceed}}</span></div>'},{field:"operate",title:"操作",toolbar:"#toolbar"}]],limit:20,data:[{id:"2572",POC_ID:"3245",name:"1#设备",type:"告警",reasons:"C相电流",time:"2018-07-02 14:39:55",lev:"一级警告",current:"823",exceed:"3434"},{id:"1793",POC_ID:"3245",name:"1#设备",type:"告警",reasons:"C相电流",time:"2018-07-02 14:39:55",lev:"一级警告",current:"823",exceed:"3434"}],done:function(){}});e.on("tool(warnTable)",function(e){var t,a,i=e.data,r=e.event;e.tr;if("chose"===r){var s=$("#repairmanLoading");tableLoadingShow(s),t=s,a=apiRoot+"/api/web/Alarm/repairman",getData({request:"GET",url:a,token:TOKEN,contentType:"application/json;charset=UTF-8"},function(e){if(console.log(e),e&&200===e.code&&e.data){var a=e.data;g.reload({data:a}),tableLoadingHide(t)}}),layui.use("layer",function(){l.open({type:1,id:"repairmanList",skin:"layer-dialog",title:"修理工列表",area:["1010px","500px"],closeBtn:1,content:$(".repairman-list"),yes:function(e,a){},success:function(e,a){O=i.ID}})})}});var g=e.render({elem:"#repairman",cols:[[{field:"id",title:"ID",templet:'<div><span class="txel">{{d.id}}</span></div>'},{field:"name",title:"名称",templet:'<div><span class="txel">{{d.name}}</span></div>'},{field:"sex",title:"性别",templet:'<div><span class="txel">{{d.sex}}</span></div>'},{field:"department",title:"所属部门",templet:'<div><span class="txel">{{d.department}}</span></div>'},{field:"duties",title:"职务",templet:'<div><span class="txel">{{d.duties}}</span></div>'},{field:"qq",title:"QQ",templet:'<div><span class="txel">{{d.qq}}</span></div>'},{field:"tel",title:"电话",templet:'<div><span class="txel">{{d.tel}}</span></div>'},{field:"operate",title:"操作",toolbar:"#toolbar"}]],width:1e3,limit:200,unresize:!0,data:[{id:2,name:"张",sex:"男",department:"xxxx",duties:"xxxxxx",qq:"45353737",tel:"134343453453"}],done:function(){}});function x(e){var a=e[0],t=[];for(var i in a)t.push({name:i,value:[]});for(var r in e)for(var s in e[r])for(var l in t)s===t[l].name&&t[l].value.push(e[r][s]);var n={};for(var o in t)n[t[o].name]=t[o].value;return{timeArr:n.coordinate,seriesArr:n}}function h(e,a){0!==e.seriesArr.voltage[a]?c.series[6].data[0].value=e.seriesArr.voltage[a]:c.series[6].data[0].value=null,0!==e.seriesArr.currents[a]?c.series[6].data[1].value=e.seriesArr.currents[a]:c.series[6].data[1].value=null,0!==e.seriesArr.pf[a]?c.series[6].data[2].value=e.seriesArr.pf[a]:c.series[6].data[2].value=null,0!==e.seriesArr.load[a]?c.series[6].data[3].value=e.seriesArr.load[a]:c.series[6].data[3].value=null,0!==e.seriesArr.temperature[a]?c.series[6].data[4].value=e.seriesArr.temperature[a]:c.series[6].data[4].value=null,0!==e.seriesArr.unbalance[a]?c.series[6].data[5].value=e.seriesArr.unbalance[a]:c.series[6].data[5].value=null}e.on("tool(repairmanTable)",function(e){var s=e.data,a=e.event;e.tr;console.log(s),"chose"===a&&layui.use("layer",function(){l.open({type:1,id:"batch_del",skin:"layer-dialog",title:"指派修理工",btn:["提交","关闭"],btnAlign:"c",closeBtn:1,content:'<div style="padding: 20px 0;text-align:center;">确定要指派 '+s.name+" 吗？</div>",yes:function(e,a){var t,i,r;t=O,i=s.id,r=apiRoot+"/api/web/Alarm/assign/"+t+"/"+i,getData({request:"POST",url:r,token:TOKEN,contentType:"application/json;charset=UTF-8"},function(e){if(console.log(e),e&&200===e.code){var a=e.data;console.log(a),l.closeAll(),l.msg("指派成功！",{skin:"repairman-tips"}),0===A||1===A||2===A?u():3===A&&v()}else l.close(y),l.msg("指派失败，请稍后重试！")}),y=e},btn2:function(e){l.close(e)}})})}),$("#btnQuery").on("click",function(){""===L&&""===w?l.msg("请先选择时间！"):(m(),v())}),$("#menuTree").contextMenu({selector:"a",items:{firstCommand:{name:"选择",icon:"select",className:"contextmenu-select",callback:function(e,a,t){$(".on").removeClass("on"),$(this).addClass("on");var i=$(this).data("menuid");T=i,$(".chart-nodata").remove(),0===A||1===A||2===A?(p(),u()):3===A&&(m(),v())}}}})})});